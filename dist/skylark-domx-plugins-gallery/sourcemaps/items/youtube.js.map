{"version":3,"sources":["items/youtube.js"],"names":["define","langx","noder","$","Gallery","video","YouTubePlayer","Evented","inherit","klassName","init","videoId","playerVars","clickToPlay","this","element","document","createElement","listeners","on","type","func","canPlayType","loadAPI","scriptTag","that","onYouTubeIframeAPIReady","window","apiUrl","scriptTags","getElementsByTagName","i","length","apply","playOnReady","play","src","parentNode","insertBefore","onReady","ready","onPlaying","playStatus","playing","onPause","prototype","setTimeout","call","checkSeek","stateChange","YT","PlayerState","PAUSED","ENDED","pause","onStateChange","event","data","PLAYING","hasPlayed","onError","trigger","navigator","test","platform","player","playVideo","Player","events","pauseVideo","YouTubeItemFactory","ctor","options","youTubeVideoIdProperty","youTubePlayerVars","wmode","youTubeClickToPlay","initOptions","overrided","mixin","render","obj","callback","getItemProperty","undefined","urlProperty","videoPosterProperty","pluginInfo","name","mimeType","installAddon"],"mappings":"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","file":"../../items/youtube.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-noder\",\r\n  \"skylark-domx-query\",\r\n  '../Gallery',\r\n  './video'\r\n], function (langx, noder, $, Gallery, video) {\r\n  'use strict'\r\n\r\n  var YouTubePlayer = langx.Evented.inherit({\r\n    klassName: \"YouTubePlayer\",\r\n\r\n    init: function (videoId, playerVars, clickToPlay) {\r\n      this.videoId = videoId;\r\n      this.playerVars = playerVars;\r\n      this.clickToPlay = clickToPlay;\r\n      this.element = document.createElement('div');\r\n      this.listeners = {}\r\n    },\r\n\r\n    on: function (type, func) {\r\n      this.listeners[type] = func\r\n      return this\r\n    },\r\n    canPlayType: function () {\r\n      return true;\r\n    },\r\n\r\n    loadAPI: function () {\r\n      var that = this,\r\n        onYouTubeIframeAPIReady = window.onYouTubeIframeAPIReady,\r\n        apiUrl = 'https://www.youtube.com/iframe_api',\r\n        scriptTags = document.getElementsByTagName('script'),\r\n        i = scriptTags.length,\r\n        scriptTag;\r\n\r\n      window.onYouTubeIframeAPIReady = function () {\r\n        if (onYouTubeIframeAPIReady) {\r\n          onYouTubeIframeAPIReady.apply(this);\r\n        }\r\n        if (that.playOnReady) {\r\n          that.play();\r\n        }\r\n      }\r\n      while (i) {\r\n        i -= 1\r\n        if (scriptTags[i].src === apiUrl) {\r\n          return\r\n        }\r\n      }\r\n      scriptTag = document.createElement('script')\r\n      scriptTag.src = apiUrl\r\n      scriptTags[0].parentNode.insertBefore(scriptTag, scriptTags[0])\r\n    },\r\n\r\n    onReady: function () {\r\n      this.ready = true;\r\n      if (this.playOnReady) {\r\n        this.play()\r\n      }\r\n    },\r\n\r\n    onPlaying: function () {\r\n      if (this.playStatus < 2) {\r\n        this.listeners.playing();\r\n        this.playStatus = 2;\r\n      }\r\n    },\r\n\r\n    onPause: function () {\r\n      Gallery.prototype.setTimeout.call(this, this.checkSeek, null, 2000)\r\n    },\r\n\r\n    checkSeek: function () {\r\n      if (\r\n        this.stateChange === YT.PlayerState.PAUSED ||\r\n        this.stateChange === YT.PlayerState.ENDED\r\n      ) {\r\n        // check if current state change is actually paused\r\n        this.listeners.pause()\r\n        delete this.playStatus\r\n      }\r\n    },\r\n\r\n    onStateChange: function (event) {\r\n      switch (event.data) {\r\n        case YT.PlayerState.PLAYING:\r\n          this.hasPlayed = true\r\n          this.onPlaying()\r\n          break\r\n        case YT.PlayerState.PAUSED:\r\n        case YT.PlayerState.ENDED:\r\n          this.onPause()\r\n          break\r\n      }\r\n      // Save most recent state change to this.stateChange\r\n      this.stateChange = event.data\r\n    },\r\n\r\n    onError: function (event) {\r\n      this.trigger(\"error\", event);\r\n    },\r\n\r\n    play: function () {\r\n      var that = this\r\n      if (!this.playStatus) {\r\n        this.listeners.play();\r\n        this.playStatus = 1;\r\n      }\r\n      if (this.ready) {\r\n        if (\r\n          !this.hasPlayed &&\r\n          (this.clickToPlay ||\r\n            (window.navigator &&\r\n              /iP(hone|od|ad)/.test(window.navigator.platform)))\r\n        ) {\r\n          // Manually trigger the playing callback if clickToPlay\r\n          // is enabled and to workaround a limitation in iOS,\r\n          // which requires synchronous user interaction to start\r\n          // the video playback:\r\n          this.onPlaying();\r\n        } else {\r\n          this.player.playVideo();\r\n        }\r\n      } else {\r\n        this.playOnReady = true;\r\n        if (!(window.YT && YT.Player)) {\r\n          this.loadAPI();\r\n        } else if (!this.player) {\r\n          this.player = new YT.Player(this.element, {\r\n            videoId: this.videoId,\r\n            playerVars: this.playerVars,\r\n            events: {\r\n              onReady: function () {\r\n                that.onReady()\r\n              },\r\n              onStateChange: function (event) {\r\n                that.onStateChange(event)\r\n              },\r\n              onError: function (event) {\r\n                that.onError(event)\r\n              }\r\n            }\r\n          })\r\n        }\r\n      }\r\n    },\r\n\r\n    pause: function () {\r\n      if (this.ready) {\r\n        this.player.pauseVideo()\r\n      } else if (this.playStatus) {\r\n        delete this.playOnReady\r\n        this.listeners.pause()\r\n        delete this.playStatus\r\n      }\r\n    }\r\n  });\r\n\r\n\r\n  var YouTubeItemFactory = video.ctor.inherit({\r\n    klassName: \"YouTubeItemFactory\",\r\n\r\n    YouTubePlayer: YouTubePlayer,\r\n\r\n    options: {\r\n      // The list object property (or data attribute) with the YouTube video id:\r\n      youTubeVideoIdProperty: 'youtube',\r\n      // Optional object with parameters passed to the YouTube video player:\r\n      // https://developers.google.com/youtube/player_parameters\r\n      youTubePlayerVars: {\r\n        wmode: 'transparent'\r\n      },\r\n      // Require a click on the native YouTube player for the initial playback:\r\n      youTubeClickToPlay: true\r\n    },\r\n\r\n    initOptions: function (options) {\r\n      this.overrided();\r\n      this.options = langx.mixin(this.options, YouTubeItemFactory.prototype.options, options);\r\n    },\r\n\r\n    render: function (obj, callback) {\r\n      var options = this.options\r\n      var videoId = this.getItemProperty(obj, options.youTubeVideoIdProperty)\r\n      if (videoId) {\r\n        if (this.getItemProperty(obj, options.urlProperty) === undefined) {\r\n          obj[options.urlProperty] = '//www.youtube.com/watch?v=' + videoId\r\n        }\r\n        if (\r\n          this.getItemProperty(obj, options.videoPosterProperty) === undefined\r\n        ) {\r\n          obj[options.videoPosterProperty] =\r\n            '//img.youtube.com/vi/' + videoId + '/maxresdefault.jpg'\r\n        }\r\n        return this.overrided(\r\n          obj,\r\n          callback,\r\n          new YouTubePlayer(\r\n            videoId,\r\n            options.youTubePlayerVars,\r\n            options.youTubeClickToPlay\r\n          )\r\n        )\r\n      }\r\n    }\r\n  });\r\n\r\n  var pluginInfo = {\r\n    name: \"youtube\",\r\n    mimeType: \"youtube\",\r\n    ctor: YouTubeItemFactory\r\n  };\r\n\r\n  Gallery.installAddon(\"items\", pluginInfo);\r\n\r\n  return pluginInfo;\r\n});"]}