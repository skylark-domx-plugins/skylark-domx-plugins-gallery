{"version":3,"sources":["items/youtube.js"],"names":["define","langx","noder","$","Gallery","video","YouTubePlayer","Evented","inherit","klassName","init","videoId","playerVars","clickToPlay","this","element","document","createElement","canPlayType","loadAPI","scriptTag","that","onYouTubeIframeAPIReady","window","apiUrl","scriptTags","getElementsByTagName","i","length","apply","playOnReady","play","src","parentNode","insertBefore","onReady","ready","onPlaying","playStatus","emit","onPause","defer","checkSeek","stateChange","YT","PlayerState","PAUSED","ENDED","onStateChange","event","data","PLAYING","hasPlayed","onError","trigger","navigator","test","platform","player","playVideo","Player","events","pause","pauseVideo","YouTubeItemFactory","ctor","options","youTubeVideoIdProperty","youTubePlayerVars","wmode","youTubeClickToPlay","initOptions","overrided","mixin","prototype","render","obj","callback","getItemProperty","undefined","urlProperty","videoPosterProperty","pluginInfo","name","mimeType","installAddon"],"mappings":"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","file":"../../items/youtube.js","sourcesContent":["define([\r\n  \"skylark-langx/langx\",\r\n  \"skylark-domx-noder\",\r\n  \"skylark-domx-query\",\r\n  '../Gallery',\r\n  './video'\r\n], function (langx, noder, $, Gallery, video) {\r\n  'use strict'\r\n\r\n  var YouTubePlayer = langx.Evented.inherit({\r\n    klassName: \"YouTubePlayer\",\r\n\r\n    init: function (videoId, playerVars, clickToPlay) {\r\n      this.videoId = videoId;\r\n      this.playerVars = playerVars;\r\n      this.clickToPlay = clickToPlay;\r\n      this.element = document.createElement('div');\r\n    },\r\n\r\n    canPlayType: function () {\r\n      return true;\r\n    },\r\n\r\n    loadAPI: function () {\r\n      var that = this,\r\n        onYouTubeIframeAPIReady = window.onYouTubeIframeAPIReady,\r\n        apiUrl = 'https://www.youtube.com/iframe_api',\r\n        scriptTags = document.getElementsByTagName('script'),\r\n        i = scriptTags.length,\r\n        scriptTag;\r\n\r\n      window.onYouTubeIframeAPIReady = function () {\r\n        if (onYouTubeIframeAPIReady) {\r\n          onYouTubeIframeAPIReady.apply(this);\r\n        }\r\n        if (that.playOnReady) {\r\n          that.play();\r\n        }\r\n      }\r\n      while (i) {\r\n        i -= 1\r\n        if (scriptTags[i].src === apiUrl) {\r\n          return\r\n        }\r\n      }\r\n      scriptTag = document.createElement('script')\r\n      scriptTag.src = apiUrl\r\n      scriptTags[0].parentNode.insertBefore(scriptTag, scriptTags[0])\r\n    },\r\n\r\n    onReady: function () {\r\n      this.ready = true;\r\n      if (this.playOnReady) {\r\n        this.play()\r\n      }\r\n    },\r\n\r\n    onPlaying: function () {\r\n      if (this.playStatus < 2) {\r\n        this.emit(\"playing\");\r\n        this.playStatus = 2;\r\n      }\r\n    },\r\n\r\n    onPause: function () {\r\n      langx.defer(()=>{\r\n        this.checkSeek();\r\n      },2000)\r\n    },\r\n\r\n    checkSeek: function () {\r\n      if (\r\n        this.stateChange === YT.PlayerState.PAUSED ||\r\n        this.stateChange === YT.PlayerState.ENDED\r\n      ) {\r\n        // check if current state change is actually paused\r\n        this.emit(\"pause\");\r\n        delete this.playStatus\r\n      }\r\n    },\r\n\r\n    onStateChange: function (event) {\r\n      switch (event.data) {\r\n        case YT.PlayerState.PLAYING:\r\n          this.hasPlayed = true\r\n          this.onPlaying()\r\n          break\r\n        case YT.PlayerState.PAUSED:\r\n        case YT.PlayerState.ENDED:\r\n          this.onPause()\r\n          break\r\n      }\r\n      // Save most recent state change to this.stateChange\r\n      this.stateChange = event.data\r\n    },\r\n\r\n    onError: function (event) {\r\n      this.trigger(\"error\", event);\r\n    },\r\n\r\n    play: function () {\r\n      var that = this\r\n      if (!this.playStatus) {\r\n        this.emit(\"play\");\r\n        this.playStatus = 1;\r\n      }\r\n      if (this.ready) {\r\n        if (\r\n          !this.hasPlayed &&\r\n          (this.clickToPlay ||\r\n            (window.navigator &&\r\n              /iP(hone|od|ad)/.test(window.navigator.platform)))\r\n        ) {\r\n          // Manually trigger the playing callback if clickToPlay\r\n          // is enabled and to workaround a limitation in iOS,\r\n          // which requires synchronous user interaction to start\r\n          // the video playback:\r\n          this.onPlaying();\r\n        } else {\r\n          this.player.playVideo();\r\n        }\r\n      } else {\r\n        this.playOnReady = true;\r\n        if (!(window.YT && YT.Player)) {\r\n          this.loadAPI();\r\n        } else if (!this.player) {\r\n          this.player = new YT.Player(this.element, {\r\n            videoId: this.videoId,\r\n            playerVars: this.playerVars,\r\n            events: {\r\n              onReady: function () {\r\n                that.onReady()\r\n              },\r\n              onStateChange: function (event) {\r\n                that.onStateChange(event)\r\n              },\r\n              onError: function (event) {\r\n                that.onError(event)\r\n              }\r\n            }\r\n          })\r\n        }\r\n      }\r\n    },\r\n\r\n    pause: function () {\r\n      if (this.ready) {\r\n        this.player.pauseVideo()\r\n      } else if (this.playStatus) {\r\n        delete this.playOnReady\r\n        this.emit(\"pause\");\r\n        delete this.playStatus\r\n      }\r\n    }\r\n  });\r\n\r\n\r\n  var YouTubeItemFactory = video.ctor.inherit({\r\n    klassName: \"YouTubeItemFactory\",\r\n\r\n    YouTubePlayer: YouTubePlayer,\r\n\r\n    options: {\r\n      // The list object property (or data attribute) with the YouTube video id:\r\n      youTubeVideoIdProperty: 'youtube',\r\n      // Optional object with parameters passed to the YouTube video player:\r\n      // https://developers.google.com/youtube/player_parameters\r\n      youTubePlayerVars: {\r\n        wmode: 'transparent'\r\n      },\r\n      // Require a click on the native YouTube player for the initial playback:\r\n      youTubeClickToPlay: true\r\n    },\r\n\r\n    initOptions: function (options) {\r\n      this.overrided();\r\n      this.options = langx.mixin(this.options, YouTubeItemFactory.prototype.options, options);\r\n    },\r\n\r\n    render: function (obj, callback) {\r\n      var options = this.options\r\n      var videoId = this.getItemProperty(obj, options.youTubeVideoIdProperty)\r\n      if (videoId) {\r\n        if (this.getItemProperty(obj, options.urlProperty) === undefined) {\r\n          obj[options.urlProperty] = '//www.youtube.com/watch?v=' + videoId\r\n        }\r\n        if (\r\n          this.getItemProperty(obj, options.videoPosterProperty) === undefined\r\n        ) {\r\n          obj[options.videoPosterProperty] =\r\n            '//img.youtube.com/vi/' + videoId + '/maxresdefault.jpg'\r\n        }\r\n        return this.overrided(\r\n          obj,\r\n          callback,\r\n          new YouTubePlayer(\r\n            videoId,\r\n            options.youTubePlayerVars,\r\n            options.youTubeClickToPlay\r\n          )\r\n        )\r\n      }\r\n    }\r\n  });\r\n\r\n  var pluginInfo = {\r\n    name: \"youtube\",\r\n    mimeType: \"youtube\",\r\n    ctor: YouTubeItemFactory\r\n  };\r\n\r\n  Gallery.installAddon(\"items\", pluginInfo);\r\n\r\n  return pluginInfo;\r\n});"]}